<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mahalle Veri Haritası</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Arial; }

#map {
  width:100%;
  height:70vh;
}

#panel {
  position:absolute;
  top:10px;
  left:10px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,0.2);
  z-index:1000;
}

button {
  display:block;
  margin:5px 0;
  width:120px;
}

#chartContainer {
  width:100%;
  height:30vh;
  background:white;
  border-top:2px solid #ddd;
}
</style>
</head>

<body>

<div id="panel">
  <button onclick="katmanAc('nufus')">Nüfus</button>
  <button onclick="katmanAc('yas')">Yaş</button>
  <button onclick="katmanAc('egitim')">Eğitim</button>
  <button onclick="katmanAc('medeni')">Medeni</button>
  <button onclick="temizle()">Temizle</button>
</div>

<div id="map"></div>

<div id="chartContainer">
  <canvas id="mahalleGrafik"></canvas>
</div>

<script>

// harita
var map = L.map('map').setView([41.402, 27.35], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
}).addTo(map);

// aktif katman
let aktifKatman = null;
let mahalleLayer = [];
let grafik;

// mahalle koordinatları
const mahalleler = {
  sevgi:[41.3919,27.3454],
  "8 kasım":[41.3901,27.3549],
  hürriyet:[41.4031,27.3424],
  yılmaz:[41.4120,27.3508],
  dere:[41.4090,27.3321],
  gençlik:[41.3981,27.3491],
  kurtuluş:[41.3989,27.3565],
  siteler:[41.3966,27.3570],
  yıldız:[41.3982,27.3659],
  inönü:[41.4019,27.3600],
  kocasinan:[41.4068,27.3453],
  gündoğu:[41.4082,27.3630],
  atatürk:[41.4033,27.3697],
  güneş:[41.4058,27.3698],
  cumhuriyet:[41.4139,27.3592],
  barış:[41.4116,27.3598]
};

// örnek veri
const veri = {
  sevgi:{nufus:3200, yas:[400,600,900,800,500], egitim:2, medeni:"evli"},
  hürriyet:{nufus:2800, yas:[300,500,800,700,400], egitim:4, medeni:"bekar"},
  yılmaz:{nufus:3600, yas:[500,700,1000,900,500], egitim:1, medeni:"evli"},
  kocasinan:{nufus:4200, yas:[600,800,1200,1000,600], egitim:5, medeni:"evli"},
  barış:{nufus:3000, yas:[450,650,900,700,300], egitim:3, medeni:"bekar"}
};

// renk fonksiyonları
function egitimRenk(k){
  const renkler=["yellow","red","green","blue","purple","orange"];
  return renkler[k] || "gray";
}

function yasRenk(v){
  if(v>1000) return "#800026";
  if(v>800) return "#BD0026";
  if(v>600) return "#E31A1C";
  if(v>400) return "#FC4E2A";
  return "#FD8D3C";
}

function medeniRenk(m){
  return m=="evli" ? "green" : "blue";
}

// katman aç
function katmanAc(tip){

  temizle();
  aktifKatman = tip;

  Object.keys(mahalleler).forEach(ad=>{

    let koordinat = mahalleler[ad];
    let v = veri[ad] || {nufus:2000,yas:[200,300,400,500,200],egitim:2,medeni:"bekar"};

    let renk="gray";

    if(tip=="nufus") renk = yasRenk(v.nufus/3);
    if(tip=="yas") renk = yasRenk(v.yas[2]);
    if(tip=="egitim") renk = egitimRenk(v.egitim);
    if(tip=="medeni") renk = medeniRenk(v.medeni);

    let daire = L.circle(koordinat,{
      radius:300,
      color:renk,
      fillOpacity:0.7
    }).addTo(map);

    daire.on("click",function(){

      let bilgi="";

      if(tip=="nufus") bilgi="Nüfus: "+v.nufus;
      if(tip=="yas") bilgi="Yaş ortası: "+v.yas[2];
      if(tip=="egitim") bilgi="Eğitim seviye: "+v.egitim;
      if(tip=="medeni") bilgi="Medeni: "+v.medeni;

      daire.bindPopup("<b>"+ad+"</b><br>"+bilgi).openPopup();

      grafikGuncelle(ad,v);

    });

    mahalleLayer.push(daire);

  });

}

// temizle
function temizle(){
  mahalleLayer.forEach(l=>map.removeLayer(l));
  mahalleLayer=[];
}

// grafik
function grafikGuncelle(ad,v){

  const ctx=document.getElementById('mahalleGrafik').getContext('2d');

  if(grafik) grafik.destroy();

  grafik = new Chart(ctx,{
    type:'bar',
    data:{
      labels:['0-14','15-24','25-44','45-64','65+'],
      datasets:[{
        label: ad+" yaş dağılımı",
        data:v.yas
      }]
    },
    options:{
      responsive:true,
      plugins:{
        title:{
          display:true,
          text: ad+" demografik grafik"
        }
      }
    }
  });

}

</script>

</body>
</html>
